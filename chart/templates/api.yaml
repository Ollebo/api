apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ollebo-api
  template:
    metadata:
      labels:
        app: ollebo-api
    spec:
      containers:
        - image: {{ .Values.image.repository}}:{{ .Values.image.tag }}
          name: api
          imagePullPolicy: Always
          env:
            - name: REDISHOST
              value: redis
            - name: REDIS
              value: redis
            - name: REDISPORT
              value: "6379"
            - name: AUTH_TOKENS
              value: "['1234','6789']"
            - name: ELASTICSEARCH
              value: http://elasticsearch:9200
            - name: ES_INDEX
              value: ollebo
            - name: INDB
              value: influxdb
            - name: INDB_PORT
              value: "8086"
            - name: INDB_USER
              value: influxdb
            - name: INDB_PASSWORD
              value: influxdb
            - name: INDB_DATABASE
              value: ollebo
            - name: INDB_TOKEN
              value: aaaaaaaaa
            - name: INDB_ORG
              value: ollebo
            - name:  MEILISEARCH
              value: http://meilisearch:7700
            - name:  KAFKA
              value: redpanda-external.redpanda:9094
            - name:  MEILISEARCH_KEY
              valueFrom:
                secretKeyRef:
                  name: meilisearch-master-key
                  key: MEILI_MASTER_KEY
            - name:  MONGOURL
              valueFrom:
                secretKeyRef:
                  name: mongodb-cluster-ollebo-mongouser
                  key: connectionString.standard
            - name: PROJECT
              value: ollebo
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: ollebo-api
  name: api
  annotations:
    external-dns.alpha.kubernetes.io/hostname: api.ollebo.com
spec:
  ports:
  - name: api
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: ollebo-api
  sessionAffinity: None
  type: ClusterIP